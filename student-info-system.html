<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>上海第二工业大学学生信息管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 配置Tailwind自定义颜色 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        accent: '#722ED1',
                        neutral: '#F5F7FA',
                        'neutral-dark': '#1D2129',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .form-input-focus {
                @apply focus:ring-2 focus:ring-primary/50 focus:border-primary focus:outline-none;
            }
            .card-shadow {
                @apply shadow-lg hover:shadow-xl transition-shadow duration-300;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-neutral-dark">
    <!-- 页面容器 -->
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- 头部标题 -->
        <header class="text-center mb-10">
            <div class="flex items-center justify-center mb-3">
                <img src="https://picsum.photos/60/60" alt="上海第二工业大学校徽" class="w-15 h-12 mr-3">
                <h1 class="text-[clamp(1.5rem,3vw,2rem)] font-bold text-primary">上海第二工业大学</h1>
            </div>
            <p class="text-gray-600 text-lg">学生信息管理系统</p>
        </header>
        
        <!-- 主内容区 -->
        <main>
            <!-- 登录表单 -->
            <section id="login-section" class="max-w-md mx-auto bg-white rounded-xl p-8 card-shadow">
                <h2 class="text-2xl font-bold text-center mb-6 text-neutral-dark">用户登录</h2>
                
                <form id="login-form" class="space-y-5">
                    <div>
                        <label for="login-username" class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-user"></i>
                            </span>
                            <input type="text" id="login-username" name="login-username" 
                                class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg form-input-focus transition duration-200"
                                required>
                        </div>
                    </div>
                    
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-lock"></i>
                            </span>
                            <input type="password" id="login-password" name="login-password" 
                                class="w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg form-input-focus transition duration-200"
                                required>
                            <button type="button" id="toggle-login-password" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500 hover:text-primary transition-colors">
                                <i class="fa fa-eye-slash"></i>
                            </button>
                        </div>
                        <p id="login-password-validation" class="mt-1 text-xs hidden"></p>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <input id="remember-me" name="remember-me" type="checkbox" 
                                class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                            <label for="remember-me" class="ml-2 block text-sm text-gray-700">
                                记住我
                            </label>
                        </div>
                        <a href="#" class="text-sm text-primary hover:text-primary/80 transition-colors">
                            忘记密码?
                        </a>
                    </div>
                    
                    <div>
                        <button type="submit" 
                            class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                            <i class="fa fa-sign-in mr-2"></i> 登录
                        </button>
                    </div>
                </form>
                
                <div class="mt-6 text-center">
                    <p class="text-gray-600">
                        还没有账号? <button id="show-register" class="text-primary font-medium hover:underline">立即注册</button>
                    </p>
                </div>
            </section>
            
            <!-- 注册表单 -->
            <section id="register-section" class="max-w-md mx-auto bg-white rounded-xl p-8 card-shadow hidden">
                <h2 class="text-2xl font-bold text-center mb-6 text-neutral-dark">用户注册</h2>
                
                <form id="register-form" class="space-y-5">
                    <div>
                        <label for="register-username" class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-user-plus"></i>
                            </span>
                            <input type="text" id="register-username" name="register-username" 
                                class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg form-input-focus transition duration-200"
                                required>
                        </div>
                    </div>
                    
                    <div>
                        <label for="register-password" class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-lock"></i>
                            </span>
                            <input type="password" id="register-password" name="register-password" 
                                class="w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg form-input-focus transition duration-200"
                                required>
                            <button type="button" id="toggle-register-password" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500 hover:text-primary transition-colors">
                                <i class="fa fa-eye-slash"></i>
                            </button>
                        </div>
                        <p id="password-hint" class="mt-1 text-xs text-gray-500">
                            密码至少8个字符，需包含英文符号、字母和数字
                        </p>
                        <p id="password-validation" class="mt-1 text-xs hidden"></p>
                    </div>
                    
                    <div>
                        <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-1">确认密码</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-lock"></i>
                            </span>
                            <input type="password" id="confirm-password" name="confirm-password" 
                                class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg form-input-focus transition duration-200"
                                required>
                        </div>
                        <p id="password-match" class="mt-1 text-xs hidden"></p>
                    </div>
                    
                    <div>
                        <button type="submit" 
                            class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                            <i class="fa fa-user-plus mr-2"></i> 注册
                        </button>
                    </div>
                </form>
                
                <div class="mt-6 text-center">
                    <p class="text-gray-600">
                        已有账号? <button id="show-login" class="text-primary font-medium hover:underline">登录</button>
                    </p>
                </div>
            </section>
            
            <!-- 学生信息表单 -->
            <section id="student-info-section" class="max-w-4xl mx-auto bg-white rounded-xl p-8 card-shadow hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-neutral-dark">学生信息填写</h2>
                    <button id="logout-btn" class="text-gray-600 hover:text-red-500 transition-colors flex items-center">
                        <i class="fa fa-sign-out mr-1"></i> 退出登录
                    </button>
                </div>
                
                <form id="student-info-form" class="space-y-6">
                    <!-- 基本信息 -->
                    <div class="border-b border-gray-200 pb-6">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">基本信息</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-5">
                            <div>
                                <label for="student-id" class="block text-sm font-medium text-gray-700 mb-1">学号 <span class="text-red-500">*</span></label>
                                <input type="text" id="student-id" name="student-id" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-focus transition duration-200">
                            </div>
                            
                            <div>
                                <label for="name" class="block text-sm font-medium text-gray-700 mb-1">姓名 <span class="text-red-500">*</span></label>
                                <input type="text" id="name" name="name" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-focus transition duration-200">
                            </div>
                            
                            <div>
                                <label for="nationality" class="block text-sm font-medium text-gray-700 mb-1">民族 <span class="text-red-500">*</span></label>
                                <input type="text" id="nationality" name="nationality" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-focus transition duration-200">
                            </div>
                            
                            <div>
                                <label for="political-status" class="block text-sm font-medium text-gray-700 mb-1">政治面貌 <span class="text-red-500">*</span></label>
                                <select id="political-status" name="political-status" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-focus transition duration-200 bg-white">
                                    <option value="">请选择</option>
                                    <option value="党员">党员</option>
                                    <option value="团员">团员</option>
                                    <option value="群众">群众</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                  <!-- 联系信息 -->
<div class="border-b border-gray-200 pb-6">
    <h3 class="text-lg font-semibold mb-4 text-gray-800">联系信息</h3>

 <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">通讯地址 <span class="text-red-500">*</span></label>
                                <div class="grid grid-cols-1 sm:grid-cols-4 gap-3">
                                    <select id="province" name="province" required
                                        class="w-full px-1 py-2 border border-gray-300 rounded-lg form-input-focus transition duration-200 bg-white">
                                        <option value="">请选择省份</option>
                                    </select>
                                    
                                    <select id="city" name="city" disabled required
                                        class="w-full px-1 py-2 border border-gray-300 rounded-lg form-input-focus transition duration-200 bg-gray-50">
                                        <option value="">请选择城市</option>
                                    </select>
                                    
                                    <select id="district" name="district" disabled required
                                        class="w-full px-1 py-2 border border-gray-300 rounded-lg form-input-focus transition duration-200 bg-gray-50">
                                        <option value="">请选择区县</option>
                                    </select>

                                    <select id="town" name="town" disabled required
                                        class="w-full px-1 py-2 border border-gray-300 rounded-lg form-input-focus transition duration-200 bg-gray-50">
                                        <option value="">请选择乡镇</option>
                                    </select>
                        </div>
                       <div class="py-5 grid grid-cols-1 sm:grid-cols-1 gap-3">
                        <div>
                            <input type="text" id="village" name="village" required
                                class="w-full px-1 py-2 border border-gray-300 rounded-lg form-input-focus transition duration-200"
                                placeholder="剩余部分，如：*路*弄*号*室/村">
                        </div>
                     </div>
                    </div>

    
    <!-- 第一行：通讯地址 + 邮政编码 -->
    <div class="flex flex-col md:flex-row gap-5 mb-5">
        <!-- 邮政编码：固定宽度 w-36，比邮箱短 -->
        <div class="w-full md:w-36">
            <label for="postal-code" class="block text-sm font-medium text-gray-700 mb-1">邮政编码 <span class="text-red-500">*</span></label>
            <input type="text" id="postal-code" name="postal-code" required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-focus transition duration-200"
                placeholder="例如：201209">
        </div>

        <!-- 手机号码：固定宽度 w-44，比邮箱短 -->
        <div class="w-full md:w-44">
            <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">手机号码 <span class="text-red-500">*</span></label>
            <input type="tel" id="phone" name="phone" required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-focus transition duration-200"
                placeholder="例如：13800138000">
        </div>
        <!-- 电子邮箱：flex-grow:1 占满行内剩余空间，比邮政编码以及手机号码长 -->
        <div class="flex-1">
            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">电子邮箱 <span class="text-red-500">*</span></label>
            <input type="email" id="email" name="email" required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-focus transition duration-200"
                placeholder="例如：student@suibe.edu.cn">
        </div>

</div>
                    
                    <!-- 户籍与出生信息 -->
                    <div class="border-b border-gray-200 pb-6">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">户籍与出生信息</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                                <label for="household-type" class="block text-sm font-medium text-gray-700 mb-1">户口性质 <span class="text-red-500">*</span></label>
                                <select id="household-type" name="household-type" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-focus transition duration-200 bg-white">
                                    <option value="">请选择</option>
                                    <option value="农业户口">农业户口</option>
                                    <option value="非农业户口">非农业户口</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="birthdate" class="block text-sm font-medium text-gray-700 mb-1">出生日期 (yyyymmdd) <span class="text-red-500">*</span></label>
                                <input type="text" id="birthdate" name="birthdate" placeholder="例如: 20000101" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-focus transition duration-200">
                            </div>
                            
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">出生地 <span class="text-red-500">*</span></label>
                                <!-- 修改为3列布局，去掉乡镇下拉框 -->
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                    <select id="birth-province" name="birth-province" required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-focus transition duration-200 bg-white">
                                        <option value="">请选择省份</option>
                                    </select>
                                    
                                    <select id="birth-city" name="birth-city" disabled required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-focus transition duration-200 bg-gray-50">
                                        <option value="">请选择城市</option>
                                    </select>
                                    
                                    <select id="birth-district" name="birth-district" disabled required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-focus transition duration-200 bg-gray-50">
                                        <option value="">请选择区县</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 家庭信息 -->
                    <div class="border-b border-gray-200 pb-6">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">家庭信息</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-5">
                            <div>
                                <label for="father-name" class="block text-sm font-medium text-gray-700 mb-1">父亲姓名 <span class="text-red-500">*</span></label>
                                <input type="text" id="father-name" name="father-name" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-focus transition duration-200">
                            </div>
                            
                            <div>
                                <label for="father-phone" class="block text-sm font-medium text-gray-700 mb-1">父亲手机号 <span class="text-red-500">*</span></label>
                                <input type="tel" id="father-phone" name="father-phone" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-focus transition duration-200">
                            </div>
                            
                            <div>
                                <label for="father-unit" class="block text-sm font-medium text-gray-700 mb-1">父亲单位 <span class="text-red-500">*</span></label>
                                <input type="text" id="father-unit" name="father-unit" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-focus transition duration-200">
                            </div>
                            
                            <div>
                                <label for="father-job" class="block text-sm font-medium text-gray-700 mb-1">父亲职业 <span class="text-red-500">*</span></label>
                                <input type="text" id="father-job" name="father-job" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-focus transition duration-200">
                            </div>
                            
                            <div>
                                <label for="mother-name" class="block text-sm font-medium text-gray-700 mb-1">母亲姓名 <span class="text-red-500">*</span></label>
                                <input type="text" id="mother-name" name="mother-name" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-focus transition duration-200">
                            </div>
                            
                            <div>
                                <label for="mother-phone" class="block text-sm font-medium text-gray-700 mb-1">母亲手机号 <span class="text-red-500">*</span></label>
                                <input type="tel" id="mother-phone" name="mother-phone" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-focus transition duration-200">
                            </div>

                           <div>
                                <label for="mother-unit" class="block text-sm font-medium text-gray-700 mb-1">母亲单位 <span class="text-red-500">*</span></label>
                                <input type="text" id="mother-unit" name="mother-unit" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-focus transition duration-200">
                            </div>
                            
                           <div>
                                <label for="mother-job" class="block text-sm font-medium text-gray-700 mb-1">母亲职业<span class="text-red-500">*</span></label>
                                <input type="text" id="mother-job" name="mother-job" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-focus transition duration-200">
                            </div>
                        
                        </div>
                    </div>
                    
                    <!-- 教育背景 -->
                    <div>
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">教育背景</h3>
                        
                        <div>
                            <label for="high-school" class="block text-sm font-medium text-gray-700 mb-1">高中毕业学校 <span class="text-red-500">*</span></label>
                            <input type="text" id="high-school" name="high-school" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg form-input-focus transition duration-200">
                        </div>
                    </div>
                    
                    <!-- 提交按钮 -->
                    <div class="flex justify-center mt-8">
                        <button type="submit" 
                            class="bg-primary hover:bg-primary/90 text-white font-medium py-2 px-8 rounded-lg transition duration-200 flex items-center">
                            <i class="fa fa-save mr-2"></i> 保存信息
                        </button>
                    </div>
                </form>
            </section>
        </main>
        
        <!-- 页脚 -->
        <footer class="mt-16 text-center text-gray-500 text-sm">
            <p>© 2023 上海第二工业大学 学生信息管理系统 - 版权所有</p>
        </footer>
    </div>
    
    <!-- 消息提示框 -->
    <div id="toast" class="fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full opacity-0 flex items-center">
        <i id="toast-icon" class="mr-2"></i>
        <span id="toast-message"></span>
    </div>

    <script>
// 全局DOM元素引用
const loginSection = document.getElementById('login-section');
const registerSection = document.getElementById('register-section');
const studentInfoSection = document.getElementById('student-info-section');
const showRegisterBtn = document.getElementById('show-register');
const showLoginBtn = document.getElementById('show-login');
const logoutBtn = document.getElementById('logout-btn');
const toggleLoginPassword = document.getElementById('toggle-login-password');
const toggleRegisterPassword = document.getElementById('toggle-register-password');
const loginPassword = document.getElementById('login-password');
const registerPassword = document.getElementById('register-password');
const confirmPassword = document.getElementById('confirm-password');
const passwordValidation = document.getElementById('password-validation');
const loginPasswordValidation = document.getElementById('login-password-validation');
const passwordMatch = document.getElementById('password-match');
const toast = document.getElementById('toast');
const toastIcon = document.getElementById('toast-icon');
const toastMessage = document.getElementById('toast-message');
const loginForm = document.getElementById('login-form');
const registerForm = document.getElementById('register-form');
const studentInfoForm = document.getElementById('student-info-form');

// 后端API地址
const API_URL = 'http://localhost:3000/api';
let currentUserId = null;
let pcasData = [];
const municipalities = ["北京市", "上海市", "天津市", "重庆市"];

// 页面加载完成后执行
document.addEventListener('DOMContentLoaded', function() {
    // 绑定注册/登录切换事件
    showRegisterBtn.addEventListener('click', function() {
        loginSection.classList.add('hidden');
        registerSection.classList.remove('hidden');
    });

    showLoginBtn.addEventListener('click', function() {
        registerSection.classList.add('hidden');
        loginSection.classList.remove('hidden');
    });

    // 密码显示/隐藏切换
    toggleLoginPassword.addEventListener('click', function() {
        togglePasswordVisibility(loginPassword, this);
    });

    toggleRegisterPassword.addEventListener('click', function() {
        togglePasswordVisibility(registerPassword, this);
    });

    // 初始化地址选择器
    initAddressSelectors();
});

// 密码显示/隐藏切换函数
function togglePasswordVisibility(input, button) {
    const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
    input.setAttribute('type', type);
    button.querySelector('i').classList.toggle('fa-eye');
    button.querySelector('i').classList.toggle('fa-eye-slash');
}

// 完善密码验证函数
function validatePassword(password) {
    // 至少8个字符，包含字母、数字和特殊符号
    const regex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[!@#$%^&*])[A-Za-z\d!@#$%^&*]{8,}$/;
    return regex.test(password);
}

    // 1. 加载带区划代码的pcas-code.json数据
    fetch('pcas-code.json')
        .then(response => {
            if (!response.ok) throw new Error('pcas-code.json文件加载失败');
            return response.json();
        })
        .then(data => {
            pcasData = data; // 数据结构：[{code: "110000", name: "北京市", children: [...]}, ...]
            // 初始化通讯地址（四级联动）和出生地（三级联动）
            initLocationSelects(
                'province', 
                'city', 
                'district', 
                'town'
            );
            initLocationSelects(
                'birth-province', 
                'birth-city', 
                'birth-district'  // 出生地只到区县
            );
        })
        .catch(error => {
            console.error('行政区划数据加载失败:', error);
            showToast('地区数据加载失败，请检查pcas-code.json文件', false);
        });

    // 2. 初始化联动下拉框（支持3级或4级）
    function initLocationSelects(provinceId, cityId, districtId, townId) {
        const provinceSel = document.getElementById(provinceId);
        const citySel = document.getElementById(cityId);
        const districtSel = document.getElementById(districtId);
        const townSel = townId ? document.getElementById(townId) : null;

        // 初始化省份下拉框（value存code，显示name）
        provinceSel.innerHTML = '<option value="">请选择省份</option>';
        pcasData.forEach(province => {
            const option = document.createElement('option');
            option.value = province.code; // 存储区划代码（如"110000"）
            option.textContent = province.name; // 显示名称（如"北京市"）
            option.setAttribute('data-name', province.name); // 存储名称方便后续获取
            provinceSel.appendChild(option);
        });

        // 绑定各级联动事件
        provinceSel.addEventListener('change', () => {
            updateCityOptions(provinceId, cityId, districtId, townId);
        });
        citySel.addEventListener('change', () => {
            updateDistrictOptions(provinceId, cityId, districtId, townId);
        });
        // 如果有乡镇级才绑定事件
        if (townSel) {
            districtSel.addEventListener('change', () => {
                updateTownOptions(provinceId, cityId, districtId, townId);
            });
        }
    }

    // 3. 根据选中的省份更新城市下拉框（基于code匹配）
    function updateCityOptions(provinceId, cityId, districtId, townId) {
        const provinceSel = document.getElementById(provinceId);
        const citySel = document.getElementById(cityId);
        const districtSel = document.getElementById(districtId);
        const townSel = townId ? document.getElementById(townId) : null;
        const selectedProvinceCode = provinceSel.value;
        const selectedProvinceName = provinceSel.options[provinceSel.selectedIndex]?.getAttribute('data-name') || '';

        // 重置：先恢复城市框默认状态（显示+启用），避免残留样式
        citySel.innerHTML = '<option value="">请选择城市</option>';
        citySel.classList.remove('hidden'); // 移除隐藏样式
        citySel.disabled = false;

        // 重置下级区县/乡镇框
        districtSel.innerHTML = '<option value="">请选择区县</option>';
        districtSel.disabled = true;
        if (townSel) {
            townSel.innerHTML = '<option value="">请选择乡镇</option>';
            townSel.disabled = true;
        }

        // 未选择省份时，禁用城市框
        if (!selectedProvinceCode) {
            citySel.disabled = true;
            return;
        }

        // 查找选中省份的子级数据（城市级）
        const provinceData = pcasData.find(item => item.code === selectedProvinceCode);
        if (!provinceData || !provinceData.children || provinceData.children.length === 0) {
            citySel.innerHTML = '<option value="">暂无城市数据</option>';
            citySel.disabled = true;
            return;
        }

        // 直辖市处理（隐藏“市辖区”城市框）
        if (municipalities.includes(selectedProvinceName)) {
            // 提取直辖市的“市辖区”数据
            const cityData = provinceData.children.find(city => city.name === "市辖区");
            if (!cityData) {
                citySel.innerHTML = '<option value="">暂无城市数据</option>';
                citySel.disabled = true;
                return;
            }

            // 隐藏城市下拉框
            citySel.classList.add('hidden');

            // 自动填充“市辖区”数据到城市框
            citySel.innerHTML = `
                <option value="${cityData.code}" data-name="${cityData.name}" selected>
                    ${cityData.name}
                </option>
            `;

            // 直接加载区县数据
            updateDistrictOptions(provinceId, cityId, districtId, townId);
        } 
        // 普通省份处理
        else {
            // 普通省份：渲染所有城市选项
            provinceData.children.forEach(city => {
                const option = document.createElement('option');
                option.value = city.code;
                option.textContent = city.name;
                option.setAttribute('data-name', city.name);
                citySel.appendChild(option);
            });
        }
    }

    // 4. 根据选中的城市更新区县下拉框（基于code匹配）
    function updateDistrictOptions(provinceId, cityId, districtId, townId) {
        const provinceSel = document.getElementById(provinceId);
        const citySel = document.getElementById(cityId);
        const districtSel = document.getElementById(districtId);
        const townSel = townId ? document.getElementById(townId) : null;
        const selectedProvinceCode = provinceSel.value;
        const selectedCityCode = citySel.value;

        // 重置下级下拉框
        districtSel.innerHTML = '<option value="">请选择区县</option>';
        districtSel.disabled = false;
        if (townSel) {
            townSel.innerHTML = '<option value="">请选择乡镇</option>';
            townSel.disabled = true;
        }

        if (!selectedProvinceCode || !selectedCityCode) {
            districtSel.disabled = true;
            return;
        }

        // 查找选中城市的子级区县
        const provinceData = pcasData.find(p => p.code === selectedProvinceCode);
        if (!provinceData) {
            districtSel.disabled = true;
            return;
        }

        const cityData = provinceData.children.find(c => c.code === selectedCityCode);
        if (!cityData || !cityData.children || cityData.children.length === 0) {
            districtSel.innerHTML = '<option value="">暂无区县数据</option>';
            districtSel.disabled = true;
            return;
        }

        // 加载区县数据
        cityData.children.forEach(district => {
            const option = document.createElement('option');
            option.value = district.code;
            option.textContent = district.name;
            option.setAttribute('data-name', district.name);
            districtSel.appendChild(option);
        });
    }

    // 5. 根据选中的区县更新乡镇下拉框（仅用于通讯地址）
    function updateTownOptions(provinceId, cityId, districtId, townId) {
        const provinceSel = document.getElementById(provinceId);
        const citySel = document.getElementById(cityId);
        const districtSel = document.getElementById(districtId);
        const townSel = document.getElementById(townId);
        const selectedProvinceCode = provinceSel.value;
        const selectedCityCode = citySel.value;
        const selectedDistrictCode = districtSel.value;

        // 重置乡镇下拉框
        townSel.innerHTML = '<option value="">请选择乡镇</option>';
        townSel.disabled = false;

        if (!selectedProvinceCode || !selectedCityCode || !selectedDistrictCode) {
            townSel.disabled = true;
            return;
        }

        // 查找选中区县的子级乡镇
        const provinceData = pcasData.find(p => p.code === selectedProvinceCode);
        if (!provinceData) {
            townSel.disabled = true;
            return;
        }

        const cityData = provinceData.children.find(c => c.code === selectedCityCode);
        if (!cityData) {
            townSel.disabled = true;
            return;
        }

        const districtData = cityData.children.find(d => d.code === selectedDistrictCode);
        if (!districtData || !districtData.children || districtData.children.length === 0) {
            townSel.innerHTML = '<option value="">暂无乡镇数据</option>';
            townSel.disabled = true;
            return;
        }

        // 加载乡镇数据
        districtData.children.forEach(town => {
            const option = document.createElement('option');
            option.value = town.code;
            option.textContent = town.name;
            option.setAttribute('data-name', town.name);
            townSel.appendChild(option);
        });
    }

// 登录表单提交
loginForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const username = document.getElementById('login-username').value;
    const password = document.getElementById('login-password').value;
    
    try {
        const response = await fetch(`${API_URL}/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.message || '登录失败');
        }
        
        showToast('登录成功', true);
        currentUserId = data.userId;
        // 切换到学生信息页面
        loginSection.classList.add('hidden');
        studentInfoSection.classList.remove('hidden');
        // 加载学生信息
        loadStudentInfo();
    } catch (error) {
        showToast(error.message, false);
    }
});

// 注册表单提交
registerForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const username = document.getElementById('register-username').value;
    const password = document.getElementById('register-password').value;
    const confirmPwd = document.getElementById('confirm-password').value;
    
    // 客户端验证
    if (password !== confirmPwd) {
        showToast('两次密码输入不一致', false);
        return;
    }
    
    if (!validatePassword(password)) {
        showToast('密码不符合要求，至少8个字符，需包含字母、数字和特殊符号', false);
        return;
    }
    
    try {
        const response = await fetch(`${API_URL}/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.message || '注册失败');
        }
        
        showToast('注册成功，请登录', true);
        // 切换到登录页面
        registerSection.classList.add('hidden');
        loginSection.classList.remove('hidden');
    } catch (error) {
        showToast(error.message, false);
    }
});

// 学生信息表单提交
studentInfoForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!currentUserId) {
        showToast('请先登录', false);
        return;
    }
    
    // 收集表单数据
    const formData = {
        studentId: document.getElementById('student-id').value,
        name: document.getElementById('name').value,
        nationality: document.getElementById('nationality').value,
        politicalStatus: document.getElementById('political-status').value,
        province: document.getElementById('province').options[document.getElementById('province').selectedIndex]?.getAttribute('data-name') || '',
        city: document.getElementById('city').options[document.getElementById('city').selectedIndex]?.getAttribute('data-name') || '',
        district: document.getElementById('district').options[document.getElementById('district').selectedIndex]?.getAttribute('data-name') || '',
        town: document.getElementById('town')?.options[document.getElementById('town').selectedIndex]?.getAttribute('data-name') || '',
        village: document.getElementById('village').value,
        postalCode: document.getElementById('postal-code').value,
        phone: document.getElementById('phone').value,
        email: document.getElementById('email').value,
        householdType: document.getElementById('household-type').value,
        birthdate: document.getElementById('birthdate').value,
        birthProvince: document.getElementById('birth-province').options[document.getElementById('birth-province').selectedIndex]?.getAttribute('data-name') || '',
        birthCity: document.getElementById('birth-city').options[document.getElementById('birth-city').selectedIndex]?.getAttribute('data-name') || '',
        birthDistrict: document.getElementById('birth-district').options[document.getElementById('birth-district').selectedIndex]?.getAttribute('data-name') || '',
        fatherName: document.getElementById('father-name').value,
        fatherPhone: document.getElementById('father-phone').value,
        fatherUnit: document.getElementById('father-unit').value,
        fatherJob: document.getElementById('father-job').value,
        motherName: document.getElementById('mother-name').value,
        motherPhone: document.getElementById('mother-phone').value,
        motherUnit: document.getElementById('mother-unit').value,
        motherJob: document.getElementById('mother-job').value,
        highSchool: document.getElementById('high-school').value
    };
    
    try {
        const response = await fetch(`${API_URL}/student-info`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: currentUserId, ...formData })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.message || '保存失败');
        }
        
        showToast('信息保存成功', true);
    } catch (error) {
        showToast(error.message, false);
    }
});

// 加载学生信息
async function loadStudentInfo() {
    try {
        const response = await fetch(`${API_URL}/student-info/${currentUserId}`);
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error('获取信息失败');
        }
        
        if (data) {
            // 填充表单数据
            document.getElementById('student-id').value = data.student_id || '';
            document.getElementById('name').value = data.name || '';
            document.getElementById('nationality').value = data.nationality || '';
            document.getElementById('political-status').value = data.political_status || '';
            document.getElementById('postal-code').value = data.postal_code || '';
            document.getElementById('phone').value = data.phone || '';
            document.getElementById('email').value = data.email || '';
            document.getElementById('household-type').value = data.household_type || '';
            document.getElementById('birthdate').value = data.birthdate || '';
            document.getElementById('father-name').value = data.father_name || '';
            document.getElementById('father-phone').value = data.father_phone || '';
            document.getElementById('father-unit').value = data.father_unit || '';
            document.getElementById('father-job').value = data.father_job || '';
            document.getElementById('mother-name').value = data.mother_name || '';
            document.getElementById('mother-phone').value = data.mother_phone || '';
            document.getElementById('mother-unit').value = data.mother_unit || '';
            document.getElementById('mother-job').value = data.mother_job || '';
            document.getElementById('high-school').value = data.high_school || '';
            document.getElementById('village').value = data.village || '';
        }
    } catch (error) {
        console.error('加载学生信息失败:', error);
    }
}

// 退出登录
logoutBtn.addEventListener('click', function() {
    currentUserId = null;
    studentInfoSection.classList.add('hidden');
    loginSection.classList.remove('hidden');
    showToast('已退出登录', true);
});

// 消息提示函数
function showToast(message, isSuccess) {
    toastMessage.textContent = message;
    toastIcon.className = isSuccess ? 'fa fa-check-circle text-green-500 mr-2' : 'fa fa-exclamation-circle text-red-500 mr-2';
    toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-0 opacity-100 flex items-center ${isSuccess ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'}`;
    
    setTimeout(() => {
        toast.className = 'fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full opacity-0 flex items-center';
    }, 3000);
}
</script>
</body>
</html>